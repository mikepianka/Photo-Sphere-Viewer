{"version":3,"file":"cubemap-video.js","sources":["../../src/adapters/shared/AbstractVideoAdapter.js","../../src/adapters/cubemap-video/index.js"],"sourcesContent":["import * as THREE from 'three';\r\nimport { AbstractAdapter, CONSTANTS, PSVError } from '../..';\r\n\r\n/**\r\n * @typedef {Object} PSV.adapters.AbstractVideoAdapter.Video\r\n * @summary Object defining a video\r\n * @property {string} source\r\n */\r\n\r\n/**\r\n * @typedef {Object} PSV.adapters.AbstractVideoAdapter.Options\r\n * @property {boolean} [autoplay=false] - automatically start the video\r\n * @property {boolean} [muted=autoplay] - initially mute the video\r\n */\r\n\r\n/**\r\n * @summary Base video adapters class\r\n * @memberof PSV.adapters\r\n * @abstract\r\n * @private\r\n */\r\nexport class AbstractVideoAdapter extends AbstractAdapter {\r\n\r\n  static supportsTransition = false;\r\n  static supportsPreload = false;\r\n  static supportsDownload = false;\r\n\r\n  constructor(psv, options) {\r\n    super(psv);\r\n\r\n    /**\r\n     * @member {PSV.adapters.AbstractVideoAdapter.Options}\r\n     * @private\r\n     */\r\n    this.config = {\r\n      autoplay: false,\r\n      muted   : options?.autoplay ?? false,\r\n      ...options,\r\n    };\r\n\r\n    /**\r\n     * @member {HTMLVideoElement}\r\n     * @private\r\n     */\r\n    this.video = null;\r\n\r\n    this.psv.on(CONSTANTS.EVENTS.BEFORE_RENDER, this);\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  destroy() {\r\n    this.psv.off(CONSTANTS.EVENTS.BEFORE_RENDER, this);\r\n\r\n    this.__removeVideo();\r\n\r\n    super.destroy();\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  handleEvent(e) {\r\n    /* eslint-disable */\r\n    switch (e.type) {\r\n      case CONSTANTS.EVENTS.BEFORE_RENDER:\r\n        if (this.video) {\r\n          this.psv.needsUpdate();\r\n        }\r\n        break;\r\n    }\r\n    /* eslint-enable */\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   * @param {PSV.adapters.AbstractVideoAdapter.Video} panorama\r\n   * @returns {Promise.<PSV.TextureData>}\r\n   */\r\n  loadTexture(panorama) {\r\n    if (typeof panorama !== 'object' || !panorama.source) {\r\n      return Promise.reject(new PSVError('Invalid panorama configuration, are you using the right adapter?'));\r\n    }\r\n\r\n    if (!this.psv.getPlugin('video')) {\r\n      return Promise.reject(new PSVError('Video adapters require VideoPlugin to be loaded too.'));\r\n    }\r\n\r\n    const video = this.__createVideo(panorama.source);\r\n\r\n    return this.__videoLoadPromise(video)\r\n      .then(() => {\r\n        const texture = new THREE.VideoTexture(video);\r\n        return { panorama, texture };\r\n      });\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  __switchVideo(texture) {\r\n    let currentTime;\r\n    let duration;\r\n    let paused = !this.config.autoplay;\r\n    let muted = this.config.muted;\r\n    let volume = 1;\r\n    if (this.video) {\r\n      ({ currentTime, duration, paused, muted, volume } = this.video);\r\n    }\r\n\r\n    this.__removeVideo();\r\n    this.video = texture.image;\r\n\r\n    // keep current time when switching resolution\r\n    if (this.video.duration === duration) {\r\n      this.video.currentTime = currentTime;\r\n    }\r\n\r\n    // keep volume\r\n    this.video.muted = muted;\r\n    this.video.volume = volume;\r\n\r\n    // play\r\n    if (!paused) {\r\n      this.video.play();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  disposeTexture(textureData) {\r\n    if (textureData.texture) {\r\n      const video = textureData.texture.image;\r\n      video.pause();\r\n      this.psv.container.removeChild(video);\r\n    }\r\n    textureData.texture?.dispose();\r\n  }\r\n\r\n  /**\r\n   * @summary Removes the current video element\r\n   * @private\r\n   */\r\n  __removeVideo() {\r\n    if (this.video) {\r\n      this.video.pause();\r\n      this.psv.container.removeChild(this.video);\r\n      delete this.video;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Creates a new video element\r\n   * @memberOf PSV.adapters\r\n   * @param {string} src\r\n   * @return {HTMLVideoElement}\r\n   * @private\r\n   */\r\n  __createVideo(src) {\r\n    const video = document.createElement('video');\r\n    video.crossOrigin = this.psv.config.withCredentials ? 'use-credentials' : 'anonymous';\r\n    video.loop = true;\r\n    video.playsinline = true;\r\n    video.style.display = 'none';\r\n    video.muted = this.config.muted;\r\n    video.src = src;\r\n    video.preload = 'metadata';\r\n\r\n    this.psv.container.appendChild(video);\r\n\r\n    return video;\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  __videoLoadPromise(video) {\r\n    const self = this;\r\n\r\n    return new Promise((resolve, reject) => {\r\n      video.addEventListener('loadedmetadata', function onLoaded() {\r\n        if (this.video && video.duration === this.video.duration) {\r\n          resolve(self.__videoBufferPromise(video, this.video.currentTime));\r\n        }\r\n        else {\r\n          resolve();\r\n        }\r\n        video.removeEventListener('loadedmetadata', onLoaded);\r\n      });\r\n\r\n      video.addEventListener('error', function onError(err) {\r\n        reject(err);\r\n        video.removeEventListener('error', onError);\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  __videoBufferPromise(video, currentTime) {\r\n    return new Promise((resolve) => {\r\n      function onBuffer() {\r\n        const buffer = video.buffered;\r\n        for (let i = 0, l = buffer.length; i < l; i++) {\r\n          if (buffer.start(i) <= video.currentTime && buffer.end(i) >= video.currentTime) {\r\n            video.pause();\r\n            video.removeEventListener('buffer', onBuffer);\r\n            video.removeEventListener('progress', onBuffer);\r\n            resolve();\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      // try to reduce the switching time by preloading in advance\r\n      // FIXME find a better way ?\r\n      video.currentTime = Math.min(currentTime + 2000, video.duration.currentTime);\r\n      video.muted = true;\r\n\r\n      video.addEventListener('buffer', onBuffer);\r\n      video.addEventListener('progress', onBuffer);\r\n\r\n      video.play();\r\n    });\r\n  }\r\n\r\n}\r\n","import * as THREE from 'three';\r\nimport { CONSTANTS } from '../..';\r\nimport { AbstractVideoAdapter } from '../shared/AbstractVideoAdapter';\r\n\r\n/**\r\n * @typedef {Object} PSV.adapters.CubemapVideoAdapter.Video\r\n * @summary Object defining a video\r\n * @property {string} source\r\n */\r\n\r\n/**\r\n * @typedef {Object} PSV.adapters.CubemapVideoAdapter.Options\r\n * @property {boolean} [autoplay=false] - automatically start the video\r\n * @property {boolean} [muted=autoplay] - initially mute the video\r\n * @property {number} [equiangular=true] - if the video is an equiangular cubemap (EAC)\r\n */\r\n\r\n\r\n/**\r\n * @summary Adapter for cubemap videos\r\n * @memberof PSV.adapters\r\n * @extends PSV.adapters.AbstractAdapter\r\n */\r\nexport class CubemapVideoAdapter extends AbstractVideoAdapter {\r\n\r\n  static id = 'cubemap-video';\r\n\r\n  /**\r\n   * @param {PSV.Viewer} psv\r\n   * @param {PSV.adapters.CubemapVideoAdapter.Options} options\r\n   */\r\n  constructor(psv, options) {\r\n    super(psv, {\r\n      equiangular: true,\r\n      ...options,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   * @param {PSV.adapters.CubemapVideoAdapter.Video} panorama\r\n   * @returns {Promise.<PSV.TextureData>}\r\n   */\r\n  loadTexture(panorama) {\r\n    return super.loadTexture(panorama);\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  createMesh(scale = 1) {\r\n    const cubeSize = CONSTANTS.SPHERE_RADIUS * 2 * scale;\r\n    const geometry = new THREE.BoxGeometry(cubeSize, cubeSize, cubeSize)\r\n      .scale(1, 1, -1)\r\n      .toNonIndexed();\r\n\r\n    geometry.clearGroups();\r\n\r\n    const uvs = geometry.getAttribute('uv');\r\n\r\n    /*\r\n      Structure of a frame\r\n\r\n      1 +---------+---------+---------+\r\n        |         |         |         |\r\n        |  Left   |  Front  |  Right  |\r\n        |         |         |         |\r\n    1/2 +---------+---------+---------+\r\n        |         |         |         |\r\n        | Bottom  |  Back   |   Top   |\r\n        |         |         |         |\r\n      0 +---------+---------+---------+\r\n        0        1/3       2/3        1\r\n\r\n       Bottom, Back and Top are rotated 90Â° clockwise\r\n     */\r\n\r\n    // columns\r\n    const a = 0;\r\n    const b = 1 / 3;\r\n    const c = 2 / 3;\r\n    const d = 1;\r\n\r\n    // lines\r\n    const A = 1;\r\n    const B = 1 / 2;\r\n    const C = 0;\r\n\r\n    // left\r\n    uvs.setXY(0, a, A);\r\n    uvs.setXY(1, a, B);\r\n    uvs.setXY(2, b, A);\r\n    uvs.setXY(3, a, B);\r\n    uvs.setXY(4, b, B);\r\n    uvs.setXY(5, b, A);\r\n\r\n    // right\r\n    uvs.setXY(6, c, A);\r\n    uvs.setXY(7, c, B);\r\n    uvs.setXY(8, d, A);\r\n    uvs.setXY(9, c, B);\r\n    uvs.setXY(10, d, B);\r\n    uvs.setXY(11, d, A);\r\n\r\n    // top\r\n    uvs.setXY(12, d, B);\r\n    uvs.setXY(13, c, B);\r\n    uvs.setXY(14, d, C);\r\n    uvs.setXY(15, c, B);\r\n    uvs.setXY(16, c, C);\r\n    uvs.setXY(17, d, C);\r\n\r\n    // bottom\r\n    uvs.setXY(18, b, B);\r\n    uvs.setXY(19, a, B);\r\n    uvs.setXY(20, b, C);\r\n    uvs.setXY(21, a, B);\r\n    uvs.setXY(22, a, C);\r\n    uvs.setXY(23, b, C);\r\n\r\n    // back\r\n    uvs.setXY(24, c, B);\r\n    uvs.setXY(25, b, B);\r\n    uvs.setXY(26, c, C);\r\n    uvs.setXY(27, b, B);\r\n    uvs.setXY(28, b, C);\r\n    uvs.setXY(29, c, C);\r\n\r\n    // front\r\n    uvs.setXY(30, b, A);\r\n    uvs.setXY(31, b, B);\r\n    uvs.setXY(32, c, A);\r\n    uvs.setXY(33, b, B);\r\n    uvs.setXY(34, c, B);\r\n    uvs.setXY(35, c, A);\r\n\r\n    // shamelessly copied from https://github.com/videojs/videojs-vr\r\n    const material = new THREE.ShaderMaterial({\r\n      uniforms      : {\r\n        mapped     : { value: null },\r\n        contCorrect: { value: 1 },\r\n        faceWH     : { value: new THREE.Vector2(1 / 3, 1 / 2) },\r\n        vidWH      : { value: new THREE.Vector2(1, 1) },\r\n      },\r\n      vertexShader  : `\r\nvarying vec2 vUv;\r\nvoid main() {\r\n  vUv = uv;\r\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.);\r\n}`,\r\n      fragmentShader: `\r\nvarying vec2 vUv;\r\nuniform sampler2D mapped;\r\nuniform vec2 faceWH;\r\nuniform vec2 vidWH;\r\nuniform float contCorrect;\r\nconst float PI = 3.1415926535897932384626433832795;\r\nvoid main() {\r\n  vec2 corner = vUv - mod(vUv, faceWH) + vec2(0, contCorrect / vidWH.y);\r\n  vec2 faceWHadj = faceWH - vec2(0, contCorrect * 2. / vidWH.y);\r\n  vec2 p = (vUv - corner) / faceWHadj - .5;\r\n  vec2 q = ${this.config.equiangular ? '2. / PI * atan(2. * p) + .5' : 'p + .5'};\r\n  vec2 eUv = corner + q * faceWHadj;\r\n  gl_FragColor = texture2D(mapped, eUv);\r\n}`,\r\n    });\r\n\r\n    return new THREE.Mesh(geometry, material);\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  setTexture(mesh, textureData) {\r\n    const { texture } = textureData;\r\n\r\n    mesh.material.uniforms.mapped.value?.dispose();\r\n    mesh.material.uniforms.mapped.value = texture;\r\n    mesh.material.uniforms.vidWH.value.set(texture.image.videoWidth, texture.image.videoHeight);\r\n\r\n    this.__switchVideo(textureData.texture);\r\n  }\r\n\r\n}\r\n"],"names":["AbstractVideoAdapter","psv","options","config","autoplay","muted","video","on","CONSTANTS","EVENTS","BEFORE_RENDER","destroy","off","__removeVideo","handleEvent","e","type","needsUpdate","loadTexture","panorama","source","Promise","reject","PSVError","getPlugin","__createVideo","__videoLoadPromise","then","texture","THREE","VideoTexture","__switchVideo","currentTime","duration","paused","volume","image","play","disposeTexture","textureData","pause","container","removeChild","dispose","src","document","createElement","crossOrigin","withCredentials","loop","playsinline","style","display","preload","appendChild","self","resolve","addEventListener","onLoaded","__videoBufferPromise","removeEventListener","onError","err","onBuffer","buffer","buffered","i","l","length","start","end","Math","min","AbstractAdapter","supportsTransition","supportsPreload","supportsDownload","CubemapVideoAdapter","equiangular","createMesh","scale","cubeSize","SPHERE_RADIUS","geometry","BoxGeometry","toNonIndexed","clearGroups","uvs","getAttribute","a","b","c","d","A","B","C","setXY","material","ShaderMaterial","uniforms","mapped","value","contCorrect","faceWH","Vector2","vidWH","vertexShader","fragmentShader","Mesh","setTexture","mesh","set","videoWidth","videoHeight","id"],"mappings":"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"}