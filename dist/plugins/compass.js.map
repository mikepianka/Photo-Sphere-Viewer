{"version":3,"file":"compass.js","sources":["../../src/plugins/compass/index.js"],"sourcesContent":["import * as THREE from 'three';\r\nimport { AbstractPlugin, CONSTANTS, SYSTEM, utils } from '../..';\r\nimport compass from './compass.svg';\r\nimport './style.scss';\r\n\r\n\r\n/**\r\n * @typedef {Object} PSV.plugins.CompassPlugin.Options\r\n * @property {string} [size='120px'] - size of the compass\r\n * @property {string} [position='top left'] - position of the compass\r\n * @property {string} [backgroundSvg] - SVG used as background of the compass\r\n * @property {string} [coneColor='rgba(255, 255, 255, 0.5)'] - color of the cone of the compass\r\n * @property {boolean} [navigation=true] - allows to click on the compass to rotate the viewer\r\n * @property {string} [navigationColor='rgba(255, 0, 0, 0.2)'] - color of the navigation cone\r\n * @property {PSV.plugins.CompassPlugin.Hotspot[]} [hotspots] - small dots visible on the compass (will contain every marker with the \"compass\" data)\r\n * @property {string} [hotspotColor='rgba(0, 0, 0, 0.5)'] - default color of hotspots\r\n */\r\n\r\n/**\r\n * @typedef {PSV.ExtendedPosition} PSV.plugins.CompassPlugin.Hotspot\r\n * @type {string} [color] - override the global \"hotspotColor\"\r\n */\r\n\r\n\r\nconst HOTSPOT_SIZE_RATIO = 1 / 40;\r\n\r\n\r\n/**\r\n * @summary Adds a compass on the viewer\r\n * @extends PSV.plugins.AbstractPlugin\r\n * @memberof PSV.plugins\r\n */\r\nexport class CompassPlugin extends AbstractPlugin {\r\n\r\n  static id = 'compass';\r\n\r\n  /**\r\n   * @param {PSV.Viewer} psv\r\n   * @param {PSV.plugins.CompassPlugin.Options} options\r\n   */\r\n  constructor(psv, options) {\r\n    super(psv);\r\n\r\n    /**\r\n     * @member {PSV.plugins.CompassPlugin.Options}\r\n     * @private\r\n     */\r\n    this.config = {\r\n      size           : '120px',\r\n      position       : 'top left',\r\n      backgroundSvg  : compass,\r\n      coneColor      : 'rgba(255, 255, 255, 0.5)',\r\n      navigation     : true,\r\n      navigationColor: 'rgba(255, 0, 0, 0.2)',\r\n      hotspotColor   : 'rgba(0, 0, 0, 0.5)',\r\n      ...options,\r\n    };\r\n    this.config.position = utils.cleanPosition(this.config.position, 'top left');\r\n\r\n    /**\r\n     * @private\r\n     */\r\n    this.prop = {\r\n      visible  : true,\r\n      mouse    : null,\r\n      mouseDown: false,\r\n      markers  : [],\r\n    };\r\n\r\n    /**\r\n     * @type {PSV.plugins.MarkersPlugin}\r\n     * @private\r\n     */\r\n    this.markers = null;\r\n\r\n    /**\r\n     * @member {HTMLElement}\r\n     * @readonly\r\n     * @private\r\n     */\r\n    this.container = document.createElement('div');\r\n    this.container.className = `psv-compass psv-compass--${this.config.position.join('-')}`;\r\n    this.container.innerHTML = this.config.backgroundSvg;\r\n\r\n    this.container.style.width = this.config.size;\r\n    this.container.style.height = this.config.size;\r\n    if (this.config.position[0] === 'center') {\r\n      this.container.style.marginTop = `calc(-${this.config.size} / 2)`;\r\n    }\r\n    if (this.config.position[1] === 'center') {\r\n      this.container.style.marginLeft = `calc(-${this.config.size} / 2)`;\r\n    }\r\n\r\n    /**\r\n     * @member {HTMLCanvasElement}\r\n     * @readonly\r\n     * @private\r\n     */\r\n    this.canvas = document.createElement('canvas');\r\n\r\n    this.container.appendChild(this.canvas);\r\n\r\n    if (this.config.navigation) {\r\n      this.container.addEventListener('mouseenter', this);\r\n      this.container.addEventListener('mouseleave', this);\r\n      this.container.addEventListener('mousemove', this);\r\n      this.container.addEventListener('mousedown', this);\r\n      this.container.addEventListener('mouseup', this);\r\n      this.container.addEventListener('touchstart', this);\r\n      this.container.addEventListener('touchmove', this);\r\n      this.container.addEventListener('touchend', this);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @package\r\n   */\r\n  init() {\r\n    super.init();\r\n\r\n    this.markers = this.psv.getPlugin('markers');\r\n\r\n    this.psv.container.appendChild(this.container);\r\n\r\n    this.canvas.width = this.container.clientWidth * SYSTEM.pixelRatio;\r\n    this.canvas.height = this.container.clientWidth * SYSTEM.pixelRatio;\r\n\r\n    this.psv.on(CONSTANTS.EVENTS.RENDER, this);\r\n\r\n    if (this.markers) {\r\n      this.markers.on('set-markers', this);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @package\r\n   */\r\n  destroy() {\r\n    this.psv.off(CONSTANTS.EVENTS.RENDER, this);\r\n\r\n    if (this.markers) {\r\n      this.markers.off('set-markers', this);\r\n    }\r\n\r\n    this.psv.container.removeChild(this.container);\r\n\r\n    delete this.canvas;\r\n    delete this.container;\r\n\r\n    super.destroy();\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  handleEvent(e) {\r\n    switch (e.type) {\r\n      case CONSTANTS.EVENTS.RENDER:\r\n        this.__update();\r\n        break;\r\n      case 'set-markers':\r\n        this.prop.markers = e.args[0].filter(m => m.data?.compass);\r\n        this.__update();\r\n        break;\r\n      case 'mouseenter':\r\n      case 'mousemove':\r\n      case 'touchmove':\r\n        this.prop.mouse = e.changedTouches?.[0] || e;\r\n        if (this.prop.mouseDown) {\r\n          this.__click();\r\n        }\r\n        else {\r\n          this.__update();\r\n        }\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n        break;\r\n      case 'mousedown':\r\n      case 'touchstart':\r\n        this.prop.mouseDown = true;\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n        break;\r\n      case 'mouseup':\r\n      case 'touchend':\r\n        this.prop.mouse = e.changedTouches?.[0] || e;\r\n        this.prop.mouseDown = false;\r\n        this.__click();\r\n        if (e.changedTouches) {\r\n          this.prop.mouse = null;\r\n          this.__update();\r\n        }\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n        break;\r\n      case 'mouseleave':\r\n        this.prop.mouse = null;\r\n        this.prop.mouseDown = false;\r\n        this.__update();\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Hides the compass\r\n   */\r\n  hide() {\r\n    this.container.style.display = 'none';\r\n    this.prop.visible = false;\r\n  }\r\n\r\n  /**\r\n   * @summary Shows the compass\r\n   */\r\n  show() {\r\n    this.container.style.display = '';\r\n    this.prop.visible = true;\r\n  }\r\n\r\n  /**\r\n   * @summary Changes the hotspots on the compass\r\n   * @param {PSV.plugins.CompassPlugin.Hotspot[]} hotspots\r\n   */\r\n  setHotspots(hotspots) {\r\n    this.config.hotspots = hotspots;\r\n    this.__update();\r\n  }\r\n\r\n  /**\r\n   * @summary Removes all hotspots\r\n   */\r\n  clearHotspots() {\r\n    this.setHotspots(null);\r\n  }\r\n\r\n  /**\r\n   * @summary Updates the compass for current zoom and position\r\n   * @private\r\n   */\r\n  __update() {\r\n    const context = this.canvas.getContext('2d');\r\n    context.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n\r\n    const longitude = this.psv.getPosition().longitude;\r\n    const fov = THREE.MathUtils.degToRad(this.psv.prop.hFov);\r\n\r\n    this.__drawCone(context, this.config.coneColor, longitude, fov);\r\n\r\n    const mouseAngle = this.__getMouseAngle();\r\n    if (mouseAngle !== null) {\r\n      this.__drawCone(context, this.config.navigationColor, mouseAngle, fov);\r\n    }\r\n\r\n    this.prop.markers.forEach((marker) => {\r\n      this.__drawMarker(context, marker);\r\n    });\r\n    this.config.hotspots?.forEach((spot) => {\r\n      if ('longitude' in spot && !('latitude' in spot)) {\r\n        spot.latitude = 0;\r\n      }\r\n      const pos = this.psv.dataHelper.cleanPosition(spot);\r\n      this.__drawPoint(context, spot.color || this.config.hotspotColor, pos.longitude, pos.latitude);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @summary Rotates the viewer depending on the position of the mouse on the compass\r\n   * @private\r\n   */\r\n  __click() {\r\n    const mouseAngle = this.__getMouseAngle();\r\n\r\n    if (mouseAngle !== null) {\r\n      this.psv.rotate({\r\n        longitude: mouseAngle,\r\n        latitude : 0,\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Draw a cone\r\n   * @param {CanvasRenderingContext2D} context\r\n   * @param {string} color\r\n   * @param {number} longitude - in viewer reference\r\n   * @param {number} fov\r\n   * @private\r\n   */\r\n  __drawCone(context, color, longitude, fov) {\r\n    const a1 = longitude - Math.PI / 2 - fov / 2;\r\n    const a2 = a1 + fov;\r\n    const c = this.canvas.width / 2;\r\n\r\n    context.beginPath();\r\n    context.moveTo(c, c);\r\n    context.lineTo(c + Math.cos(a1) * c, c + Math.sin(a1) * c);\r\n    context.arc(c, c, c, a1, a2, false);\r\n    context.lineTo(c, c);\r\n    context.fillStyle = color;\r\n    context.fill();\r\n  }\r\n\r\n  /**\r\n   * @summary Draw a Marker\r\n   * @param {CanvasRenderingContext2D} context\r\n   * @param {PSV.plugins.MarkersPlugin.Marker} marker\r\n   * @private\r\n   */\r\n  __drawMarker(context, marker) {\r\n    let color = this.config.hotspotColor;\r\n    if (typeof marker.data.compass === 'string') {\r\n      color = marker.data.compass;\r\n    }\r\n\r\n    if (marker.isPoly()) {\r\n      context.beginPath();\r\n      marker.props.def.forEach(([longitude, latitude], i) => {\r\n        const a = longitude - Math.PI / 2;\r\n        const d = (latitude + Math.PI / 2) / Math.PI;\r\n        const c = this.canvas.width / 2;\r\n\r\n        context[i === 0 ? 'moveTo' : 'lineTo'](c + Math.cos(a) * c * d, c + Math.sin(a) * c * d);\r\n      });\r\n      if (marker.isPolygon()) {\r\n        context.fillStyle = color;\r\n        context.fill();\r\n      }\r\n      else {\r\n        context.strokeStyle = color;\r\n        context.lineWidth = Math.max(1, this.canvas.width * HOTSPOT_SIZE_RATIO / 2);\r\n        context.stroke();\r\n      }\r\n    }\r\n    else {\r\n      const pos = marker.props.position;\r\n      this.__drawPoint(context, color, pos.longitude, pos.latitude);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Draw a point\r\n   * @param {CanvasRenderingContext2D} context\r\n   * @param {string} color\r\n   * @param {number} longitude - in viewer reference\r\n   * @param {number} latitude - in viewer reference\r\n   * @private\r\n   */\r\n  __drawPoint(context, color, longitude, latitude) {\r\n    const a = longitude - Math.PI / 2;\r\n    const d = (latitude + Math.PI / 2) / Math.PI;\r\n    const c = this.canvas.width / 2;\r\n    const r = Math.max(2, this.canvas.width * HOTSPOT_SIZE_RATIO);\r\n\r\n    context.beginPath();\r\n    context.ellipse(\r\n      c + Math.cos(a) * c * d, c + Math.sin(a) * c * d,\r\n      r, r,\r\n      0, 0, Math.PI * 2\r\n    );\r\n    context.fillStyle = color;\r\n    context.fill();\r\n  }\r\n\r\n  /**\r\n   * @summary Gets the longitude corresponding to the mouse position on the compass\r\n   * @return {number | null}\r\n   * @private\r\n   */\r\n  __getMouseAngle() {\r\n    if (!this.prop.mouse) {\r\n      return null;\r\n    }\r\n\r\n    const boundingRect = this.container.getBoundingClientRect();\r\n    const mouseX = this.prop.mouse.clientX - boundingRect.left - boundingRect.width / 2;\r\n    const mouseY = this.prop.mouse.clientY - boundingRect.top - boundingRect.width / 2;\r\n\r\n    if (Math.sqrt(mouseX * mouseX + mouseY * mouseY) > boundingRect.width / 2) {\r\n      return null;\r\n    }\r\n\r\n    return Math.atan2(mouseY, mouseX) + Math.PI / 2;\r\n  }\r\n\r\n}\r\n"],"names":["HOTSPOT_SIZE_RATIO","CompassPlugin","psv","options","config","size","position","backgroundSvg","compass","coneColor","navigation","navigationColor","hotspotColor","utils","cleanPosition","prop","visible","mouse","mouseDown","markers","container","document","createElement","className","join","innerHTML","style","width","height","marginTop","marginLeft","canvas","appendChild","addEventListener","init","getPlugin","clientWidth","SYSTEM","pixelRatio","on","CONSTANTS","EVENTS","RENDER","destroy","off","removeChild","handleEvent","e","type","__update","args","filter","m","data","changedTouches","__click","stopPropagation","preventDefault","hide","display","show","setHotspots","hotspots","clearHotspots","context","getContext","clearRect","longitude","getPosition","fov","THREE","MathUtils","degToRad","hFov","__drawCone","mouseAngle","__getMouseAngle","forEach","marker","__drawMarker","spot","latitude","pos","dataHelper","__drawPoint","color","rotate","a1","Math","PI","a2","c","beginPath","moveTo","lineTo","cos","sin","arc","fillStyle","fill","isPoly","props","def","i","a","d","isPolygon","strokeStyle","lineWidth","max","stroke","r","ellipse","boundingRect","getBoundingClientRect","mouseX","clientX","left","mouseY","clientY","top","sqrt","atan2","AbstractPlugin","id"],"mappings":"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"}