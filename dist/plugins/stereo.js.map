{"version":3,"file":"stereo.js","sources":["../../src/plugins/stereo/constants.js","../../src/plugins/stereo/StereoButton.js","../../src/plugins/stereo/StereoEffect.js","../../src/plugins/stereo/index.js"],"sourcesContent":["/**\r\n * @summary Available events\r\n * @enum {string}\r\n * @memberof PSV.plugins.StereoPlugin\r\n * @constant\r\n */\r\nexport const EVENTS = {\r\n  /**\r\n   * @event stereo-updated\r\n   * @memberof PSV.plugins.StereoPlugin\r\n   * @summary Triggered when the stereo view is enabled/disabled\r\n   * @param {boolean} enabled\r\n   */\r\n  STEREO_UPDATED: 'stereo-updated',\r\n};\r\n\r\n/**\r\n * @type {string}\r\n * @constant\r\n * @private\r\n */\r\nexport const ID_OVERLAY_PLEASE_ROTATE = 'pleaseRotate';\r\n","import { AbstractButton } from '../..';\r\nimport { EVENTS } from './constants';\r\nimport stereo from './stereo.svg';\r\n\r\n/**\r\n * @summary Navigation bar stereo button class\r\n * @extends PSV.buttons.AbstractButton\r\n * @memberof PSV.buttons\r\n */\r\nexport class StereoButton extends AbstractButton {\r\n\r\n  static id = 'stereo';\r\n  static icon = stereo;\r\n\r\n  /**\r\n   * @param {PSV.components.Navbar} navbar\r\n   */\r\n  constructor(navbar) {\r\n    super(navbar, 'psv-button--hover-scale psv-stereo-button', true);\r\n\r\n    /**\r\n     * @type {PSV.plugins.StereoPlugin}\r\n     * @private\r\n     * @readonly\r\n     */\r\n    this.plugin = this.psv.getPlugin('stereo');\r\n\r\n    if (this.plugin) {\r\n      this.plugin.on(EVENTS.STEREO_UPDATED, this);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  destroy() {\r\n    if (this.plugin) {\r\n      this.plugin.off(EVENTS.STEREO_UPDATED, this);\r\n    }\r\n\r\n    delete this.plugin;\r\n\r\n    super.destroy();\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   */\r\n  isSupported() {\r\n    return !this.plugin ? false : { initial: false, promise: this.plugin.prop.isSupported };\r\n  }\r\n\r\n  /**\r\n   * @summary Handles events\r\n   * @param {Event} e\r\n   * @private\r\n   */\r\n  handleEvent(e) {\r\n    if (e.type === EVENTS.STEREO_UPDATED) {\r\n      this.toggleActive(e.args[0]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @override\r\n   * @description Toggles stereo control\r\n   */\r\n  onClick() {\r\n    this.plugin.toggle();\r\n  }\r\n\r\n}\r\n","import {\r\n\tStereoCamera,\r\n\tVector2\r\n} from 'three';\r\n\r\n/**\r\n * Copied from three.js examples\r\n * @private\r\n */\r\nclass StereoEffect {\r\n\r\n\tconstructor( renderer ) {\r\n\r\n\t\tconst _stereo = new StereoCamera();\r\n\t\t_stereo.aspect = 0.5;\r\n\t\tconst size = new Vector2();\r\n\r\n\t\tthis.setEyeSeparation = function ( eyeSep ) {\r\n\r\n\t\t\t_stereo.eyeSep = eyeSep;\r\n\r\n\t\t};\r\n\r\n\t\tthis.setSize = function ( width, height ) {\r\n\r\n\t\t\trenderer.setSize( width, height );\r\n\r\n\t\t};\r\n\r\n\t\tthis.render = function ( scene, camera ) {\r\n\r\n\t\t\tscene.updateMatrixWorld();\r\n\r\n\t\t\tif ( camera.parent === null ) camera.updateMatrixWorld();\r\n\r\n\t\t\t_stereo.update( camera );\r\n\r\n\t\t\trenderer.getSize( size );\r\n\r\n\t\t\tif ( renderer.autoClear ) renderer.clear();\r\n\t\t\trenderer.setScissorTest( true );\r\n\r\n\t\t\trenderer.setScissor( 0, 0, size.width / 2, size.height );\r\n\t\t\trenderer.setViewport( 0, 0, size.width / 2, size.height );\r\n\t\t\trenderer.render( scene, _stereo.cameraL );\r\n\r\n\t\t\trenderer.setScissor( size.width / 2, 0, size.width / 2, size.height );\r\n\t\t\trenderer.setViewport( size.width / 2, 0, size.width / 2, size.height );\r\n\t\t\trenderer.render( scene, _stereo.cameraR );\r\n\r\n\t\t\trenderer.setScissorTest( false );\r\n\r\n\t\t};\r\n\r\n\t}\r\n\r\n}\r\n\r\nexport { StereoEffect };\r\n","import { AbstractPlugin, CONSTANTS, DEFAULTS, PSVError, registerButton, utils } from '../..';\r\nimport { EVENTS, ID_OVERLAY_PLEASE_ROTATE } from './constants';\r\nimport mobileRotateIcon from './mobile-rotate.svg';\r\nimport { StereoButton } from './StereoButton';\r\nimport { StereoEffect } from './StereoEffect';\r\n\r\n\r\n/**\r\n * @external NoSleep\r\n * @description {@link https://github.com/richtr/NoSleep.js}\r\n */\r\n\r\n\r\n// add stereo button\r\nDEFAULTS.lang[StereoButton.id] = 'Stereo view';\r\nregisterButton(StereoButton, 'caption:right');\r\n\r\n// other lang strings\r\nDEFAULTS.lang.stereoNotification = 'Click anywhere to exit stereo view.';\r\nDEFAULTS.lang.pleaseRotate = ['Please rotate your device', '(or tap to continue)'];\r\n\r\n\r\nexport { EVENTS } from './constants';\r\n\r\n\r\n/**\r\n * @summary Adds stereo view on mobile devices\r\n * @extends PSV.plugins.AbstractPlugin\r\n * @memberof PSV.plugins\r\n */\r\nexport class StereoPlugin extends AbstractPlugin {\r\n\r\n  static id = 'stereo';\r\n\r\n  static EVENTS = EVENTS;\r\n\r\n  /**\r\n   * @param {PSV.Viewer} psv\r\n   */\r\n  constructor(psv) {\r\n    super(psv);\r\n\r\n    /**\r\n     * @type {PSV.plugins.GyroscopePlugin}\r\n     * @readonly\r\n     * @private\r\n     */\r\n    this.gyroscope = null;\r\n\r\n    /**\r\n     * @type {PSV.plugins.MarkersPlugin}\r\n     * @readonly\r\n     * @private\r\n     */\r\n    this.markers = null;\r\n\r\n    /**\r\n     * @type {PSV.plugins.CompassPlugin}\r\n     * @readonly\r\n     * @private\r\n     */\r\n    this.compass = null;\r\n\r\n    /**\r\n     * @member {Object}\r\n     * @protected\r\n     * @property {Promise<boolean>} isSupported - indicates of the gyroscope API is available\r\n     * @property {external:THREE.WebGLRenderer} renderer - original renderer\r\n     * @property {external:NoSleep} noSleep\r\n     * @property {WakeLockSentinel} wakeLock\r\n     */\r\n    this.prop = {\r\n      isSupported: false,\r\n      renderer   : null,\r\n      noSleep    : null,\r\n      wakeLock   : null,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * @package\r\n   */\r\n  init() {\r\n    super.init();\r\n\r\n    this.markers = this.psv.getPlugin('markers');\r\n    this.compass = this.psv.getPlugin('compass');\r\n    this.gyroscope = this.psv.getPlugin('gyroscope');\r\n\r\n    if (!this.gyroscope) {\r\n      throw new PSVError('Stereo plugin requires the Gyroscope plugin');\r\n    }\r\n\r\n    this.prop.isSupported = this.gyroscope.prop.isSupported;\r\n\r\n    this.psv.on(CONSTANTS.EVENTS.STOP_ALL, this);\r\n    this.psv.on(CONSTANTS.EVENTS.CLICK, this);\r\n  }\r\n\r\n  /**\r\n   * @package\r\n   */\r\n  destroy() {\r\n    this.psv.off(CONSTANTS.EVENTS.STOP_ALL, this);\r\n    this.psv.off(CONSTANTS.EVENTS.CLICK, this);\r\n\r\n    this.stop();\r\n\r\n    delete this.markers;\r\n    delete this.compass;\r\n    delete this.gyroscope;\r\n\r\n    super.destroy();\r\n  }\r\n\r\n  /**\r\n   * @private\r\n   */\r\n  handleEvent(e) {\r\n    switch (e.type) {\r\n      case CONSTANTS.EVENTS.STOP_ALL:\r\n      case CONSTANTS.EVENTS.CLICK:\r\n        this.stop();\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Checks if the stereo view is enabled\r\n   * @returns {boolean}\r\n   */\r\n  isEnabled() {\r\n    return !!this.prop.renderer;\r\n  }\r\n\r\n  /**\r\n   * @summary Enables the stereo view\r\n   * @description\r\n   *  - enables NoSleep.js\r\n   *  - enables full screen\r\n   *  - starts gyroscope controle\r\n   *  - hides markers, navbar and panel\r\n   *  - instanciate {@link external:THREE.StereoEffect}\r\n   * @returns {Promise}\r\n   * @fires PSV.plugins.StereoPlugin.stereo-updated\r\n   * @throws {PSV.PSVError} if the gyroscope API is not available/granted\r\n   */\r\n  start() {\r\n    // Need to be in the main event queue\r\n    this.psv.enterFullscreen();\r\n    this.__startNoSleep();\r\n    this.__lockOrientation();\r\n\r\n    return this.gyroscope.start().then(() => {\r\n      // switch renderer\r\n      this.prop.renderer = this.psv.renderer.renderer;\r\n      this.psv.renderer.renderer = new StereoEffect(this.psv.renderer.renderer);\r\n\r\n      this.psv.needsUpdate();\r\n\r\n      this.markers?.hide();\r\n      this.compass?.hide();\r\n      this.psv.navbar.hide();\r\n      this.psv.panel.hide();\r\n\r\n      this.trigger(EVENTS.STEREO_UPDATED, true);\r\n\r\n      this.psv.notification.show({\r\n        content: this.psv.config.lang.stereoNotification,\r\n        timeout: 3000,\r\n      });\r\n    }, () => {\r\n      this.__unlockOrientation();\r\n      this.__stopNoSleep();\r\n      this.psv.exitFullscreen();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @summary Disables the stereo view\r\n   * @fires PSV.plugins.StereoPlugin.stereo-updated\r\n   */\r\n  stop() {\r\n    if (this.isEnabled()) {\r\n      this.psv.renderer.renderer = this.prop.renderer;\r\n      this.prop.renderer = null;\r\n\r\n      this.psv.needsUpdate();\r\n\r\n      this.markers?.show();\r\n      this.compass?.show();\r\n      this.psv.navbar.show();\r\n\r\n      this.__unlockOrientation();\r\n      this.__stopNoSleep();\r\n      this.psv.exitFullscreen();\r\n      this.gyroscope.stop();\r\n\r\n      this.trigger(EVENTS.STEREO_UPDATED, false);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Enables or disables the stereo view\r\n   */\r\n  toggle() {\r\n    if (this.isEnabled()) {\r\n      this.stop();\r\n    }\r\n    else {\r\n      this.start();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Enables WakeLock or NoSleep.js\r\n   * @private\r\n   */\r\n  __startNoSleep() {\r\n    if ('wakeLock' in navigator) {\r\n      navigator.wakeLock.request('screen')\r\n        .then((wakeLock) => {\r\n          this.prop.wakeLock = wakeLock;\r\n        })\r\n        .catch(() => utils.logWarn('Cannot acquire WakeLock'));\r\n    }\r\n    else if ('NoSleep' in window) {\r\n      if (!this.prop.noSleep) {\r\n        this.prop.noSleep = new window.NoSleep();\r\n      }\r\n      this.prop.noSleep.enable();\r\n    }\r\n    else {\r\n      utils.logWarn('NoSleep is not available');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Disables WakeLock or NoSleep.js\r\n   * @private\r\n   */\r\n  __stopNoSleep() {\r\n    if (this.prop.wakeLock) {\r\n      this.prop.wakeLock.release();\r\n      this.prop.wakeLock = null;\r\n    }\r\n    else if (this.prop.noSleep) {\r\n      this.prop.noSleep.disable();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Tries to lock the device in landscape or display a message\r\n   * @private\r\n   */\r\n  __lockOrientation() {\r\n    let displayRotateMessageTimeout;\r\n\r\n    const displayRotateMessage = () => {\r\n      if (window.innerHeight > window.innerWidth) {\r\n        this.psv.overlay.show({\r\n          id     : ID_OVERLAY_PLEASE_ROTATE,\r\n          image  : mobileRotateIcon,\r\n          text   : this.psv.config.lang.pleaseRotate[0],\r\n          subtext: this.psv.config.lang.pleaseRotate[1],\r\n        });\r\n      }\r\n\r\n      if (displayRotateMessageTimeout) {\r\n        clearTimeout(displayRotateMessageTimeout);\r\n        displayRotateMessageTimeout = null;\r\n      }\r\n    };\r\n\r\n    if (window.screen?.orientation) {\r\n      window.screen.orientation.lock('landscape').then(null, () => displayRotateMessage());\r\n      displayRotateMessageTimeout = setTimeout(() => displayRotateMessage(), 500);\r\n    }\r\n    else {\r\n      displayRotateMessage();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @summary Unlock the device orientation\r\n   * @private\r\n   */\r\n  __unlockOrientation() {\r\n    if (window.screen?.orientation) {\r\n      window.screen.orientation.unlock();\r\n    }\r\n    else {\r\n      this.psv.overlay.hide(ID_OVERLAY_PLEASE_ROTATE);\r\n    }\r\n  }\r\n\r\n}\r\n"],"names":["EVENTS","STEREO_UPDATED","ID_OVERLAY_PLEASE_ROTATE","StereoButton","navbar","plugin","psv","getPlugin","on","destroy","off","isSupported","initial","promise","prop","handleEvent","e","type","toggleActive","args","onClick","toggle","AbstractButton","id","icon","stereo","StereoEffect","renderer","_stereo","StereoCamera","aspect","size","Vector2","setEyeSeparation","eyeSep","setSize","width","height","render","scene","camera","updateMatrixWorld","parent","update","getSize","autoClear","clear","setScissorTest","setScissor","setViewport","cameraL","cameraR","DEFAULTS","lang","registerButton","stereoNotification","pleaseRotate","StereoPlugin","gyroscope","markers","compass","noSleep","wakeLock","init","PSVError","CONSTANTS","STOP_ALL","CLICK","stop","isEnabled","start","enterFullscreen","__startNoSleep","__lockOrientation","then","needsUpdate","hide","panel","trigger","notification","show","content","config","timeout","__unlockOrientation","__stopNoSleep","exitFullscreen","navigator","request","catch","utils","logWarn","window","NoSleep","enable","release","disable","displayRotateMessageTimeout","displayRotateMessage","innerHeight","innerWidth","overlay","image","mobileRotateIcon","text","subtext","clearTimeout","screen","orientation","lock","setTimeout","unlock","AbstractPlugin"],"mappings":"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"}